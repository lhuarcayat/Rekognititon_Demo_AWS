import React, { useState, useEffect } from 'react';
import { FaceLivenessDetector } from '@aws-amplify/ui-react-liveness';
import { Button, Card, Text, Loader, View, Alert, Badge } from '@aws-amplify/ui-react';
import { verificationService } from '../services/verificationService';

function LivenessCheck({ documentImage, onComplete, onError }) {
  const [sessionId, setSessionId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [comparing, setComparing] = useState(false);
  const [retryCount, setRetryCount] = useState(0);
  const [currentStep, setCurrentStep] = useState('creating_session');
  const [progressMessage, setProgressMessage] = useState('Inicializando sesi√≥n de verificaci√≥n...');
  const [debugMode, setDebugMode] = useState(true); // Activar modo debug por defecto

  useEffect(() => {
    createLivenessSession();
  }, []);

  const createLivenessSession = async () => {
    try {
      console.log('üîÑ Creando sesi√≥n de AWS Face Liveness...');
      setLoading(true);
      setCurrentStep('creating_session');
      setProgressMessage('Creando sesi√≥n de verificaci√≥n facial...');
      
      const session = await verificationService.createLivenessSession();
      setSessionId(session.sessionId);
      setCurrentStep('session_ready');
      setProgressMessage('Sesi√≥n lista. Preparando detector facial...');
      
      console.log('‚úÖ Sesi√≥n de liveness creada:', session.sessionId);
    } catch (error) {
      console.error('‚ùå Error creando sesi√≥n:', error);
      onError('Error al inicializar la verificaci√≥n: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleAnalysisComplete = async (livenessResult) => {
    try {
      console.log('üéØ === AWS LIVENESS COMPLETADO ===');
      console.log('üéØ Resultado completo:', livenessResult);
      console.log('üéØ Tipo de resultado:', typeof livenessResult);
      console.log('üéØ Propiedades disponibles:', Object.keys(livenessResult || {}));
      
      setComparing(true);
      setCurrentStep('processing');
      setProgressMessage('Verificaci√≥n facial completada. Iniciando comparaci√≥n...');
      
      // Verificar que el liveness fue exitoso
      const isLive = livenessResult?.isLive || 
                     livenessResult?.liveness?.isLive || 
                     livenessResult?.result?.isLive ||
                     true; // Asumir que pas√≥ si lleg√≥ hasta aqu√≠

      console.log('‚úÖ ¬øEs persona real?', isLive);

      if (isLive === false) {
        onError('No se pudo verificar que seas una persona real. Intenta de nuevo.');
        return;
      }

      console.log('‚úÖ Liveness verificado - es una persona real');
      setProgressMessage('Persona real verificada. Comparando con documento...');

      // Elegir m√©todo seg√∫n modo debug
      try {
        let comparisonResult;
        
        if (debugMode) {
          console.log('üêõ Usando modo DEBUG para identificar el problema...');
          setProgressMessage('Modo DEBUG: Analizando el estado de la reference image...');
          comparisonResult = await verificationService.compareWithDocumentDebug(
            documentImage,
            sessionId
          );
        } else {
          console.log('üîÑ Usando modo SIMPLE con delays graduales...');
          setProgressMessage('Esperando que AWS procese la reference image...');
          comparisonResult = await verificationService.compareWithDocumentSimple(
            documentImage,
            sessionId
          );
        }

        console.log('‚úÖ Comparaci√≥n completada:', comparisonResult);

        // Combinar resultados de liveness + comparaci√≥n
        const finalResult = {
          isLive: isLive,
          confidence: livenessResult?.confidence || comparisonResult?.confidence || 95,
          ...comparisonResult,
          sessionId: sessionId,
          originalLivenessResult: livenessResult // Para debugging
        };

        setCurrentStep('completed');
        setProgressMessage('Verificaci√≥n completada exitosamente');
        onComplete(finalResult);

      } catch (comparisonError) {
        console.error('‚ùå Error en comparaci√≥n con documento:', comparisonError);
        
        // Logging adicional para debug
        console.log('üêõ Error details:', {
          name: comparisonError.name,
          message: comparisonError.message,
          code: comparisonError.code,
          retryable: comparisonError.retryable,
          stack: comparisonError.stack
        });
        
        // Si es un error retryable, ofrecer reintento
        if (comparisonError.retryable && retryCount < 2) {
          setRetryCount(prev => prev + 1);
          setCurrentStep('retrying');
          setProgressMessage(`Reintentando verificaci√≥n... (${retryCount + 1}/3)`);
          
          // Peque√±o delay antes de reintentar
          setTimeout(() => {
            handleRetryComparison();
          }, 3000);
        } else {
          // Error no retryable o demasiados reintentos
          let errorMessage = 'Error en la comparaci√≥n: ' + comparisonError.message;
          
          if (comparisonError.code === 'SESSION_EXPIRED') {
            errorMessage = 'La sesi√≥n ha expirado. Por favor, inicia una nueva verificaci√≥n.';
          } else if (comparisonError.code === 'REFERENCE_IMAGE_NOT_AVAILABLE') {
            errorMessage = 'AWS est√° tomando m√°s tiempo del esperado. Verifica tu conexi√≥n y reinicia la verificaci√≥n.';
          }
          
          onError(errorMessage);
        }
      }

    } catch (error) {
      console.error('‚ùå Error general en an√°lisis:', error);
      onError('Error durante la verificaci√≥n facial: ' + error.message);
    } finally {
      setComparing(false);
    }
  };

  const handleRetryComparison = async () => {
    try {
      setComparing(true);
      setProgressMessage('Reintentando comparaci√≥n...');
      
      // Usar m√©todo simple para reintentos
      const comparisonResult = await verificationService.compareWithDocumentSimple(
        documentImage,
        sessionId
      );

      console.log('‚úÖ Comparaci√≥n exitosa en reintento:', comparisonResult);

      const finalResult = {
        isLive: true,
        ...comparisonResult,
        sessionId: sessionId
      };

      setCurrentStep('completed');
      setProgressMessage('Verificaci√≥n completada exitosamente');
      onComplete(finalResult);

    } catch (error) {
      console.error('‚ùå Error en reintento:', error);
      onError('Error en la verificaci√≥n: ' + error.message);
    } finally {
      setComparing(false);
    }
  };

  const handleLivenessError = (error) => {
    console.error('‚ùå Error en AWS Face Liveness:', error);
    console.error('‚ùå Error details:', {
      name: error.name,
      message: error.message,
      state: error.state,
      stack: error.stack
    });

    let errorMessage = 'Error durante la verificaci√≥n facial';
    
    if (error.message?.includes('No credentials')) {
      errorMessage = 'Error de credenciales de AWS. Verificando configuraci√≥n...';
    } else if (error.message?.includes('Access denied')) {
      errorMessage = 'Permisos insuficientes para AWS Rekognition';
    } else if (error.state === 'SERVER_ERROR') {
      errorMessage = 'Error del servidor de AWS. Intenta de nuevo.';
    } else if (error.state === 'TIMEOUT') {
      errorMessage = 'Tiempo de espera agotado. Verifica tu conexi√≥n a internet.';
    }

    onError(errorMessage + ': ' + error.message);
  };

  const retryLiveness = () => {
    setSessionId(null);
    setLoading(true);
    setComparing(false);
    setRetryCount(0);
    setCurrentStep('creating_session');
    createLivenessSession();
  };

  // Test directo de la nueva ruta del backend
  const testBackendRoute = async () => {
    if (!sessionId) {
      console.log('‚ùå No hay sessionId para testear');
      return;
    }

    try {
      console.log('üß™ === TESTEANDO RUTA DEL BACKEND ===');
      setProgressMessage('Testeando conexi√≥n con backend...');
      
      const isAvailable = await verificationService.checkReferenceImageStatus(sessionId);
      console.log('üß™ Resultado del test:', isAvailable);
      
      alert(`Test del backend completado. Reference image disponible: ${isAvailable}`);
    } catch (error) {
      console.error('üß™ Error en test del backend:', error);
      alert(`Error en test del backend: ${error.message}`);
    }
  };

  // Componente de barra de progreso personalizada
  const CustomProgressBar = ({ value, label }) => {
    return (
      <View marginBottom="20px">
        <View style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '8px'
        }}>
          <Text fontSize="medium" fontWeight="medium">{label}</Text>
          <Badge variation="info">{value}%</Badge>
        </View>
        <View style={{
          width: '100%',
          height: '8px',
          backgroundColor: '#e9ecef',
          borderRadius: '4px',
          overflow: 'hidden'
        }}>
          <View style={{
            width: `${value}%`,
            height: '100%',
            backgroundColor: '#007bff',
            borderRadius: '4px',
            transition: 'width 0.3s ease'
          }} />
        </View>
      </View>
    );
  };

  const getProgressPercentage = () => {
    switch (currentStep) {
      case 'creating_session': return 10;
      case 'session_ready': return 25;
      case 'processing': return 60;
      case 'retrying': return 80;
      case 'completed': return 100;
      default: return 0;
    }
  };

  return (
    <Card className="liveness-card">
      <Text fontSize="xl" fontWeight="bold" marginBottom="20px">
        Paso 2: Verificaci√≥n facial en vivo con AWS
      </Text>
      
      <Text marginBottom="20px" color="gray">
        Utiliza AWS Face Liveness para verificar que eres una persona real
      </Text>

      {/* Barra de progreso personalizada */}
      <CustomProgressBar 
        value={getProgressPercentage()} 
        label={progressMessage}
      />

      {loading ? (
        <View className="loading-container">
          <Loader size="large" />
          <Text marginTop="10px">{progressMessage}</Text>
        </View>
      ) : sessionId ? (
        <View className="liveness-detector-container">
          <Text marginBottom="15px" fontSize="medium" fontWeight="bold">
            üéØ Detector AWS Face Liveness activo
          </Text>

          {/* Panel de debugging */}
          <View marginBottom="15px" style={{ 
            padding: '15px', 
            backgroundColor: '#f8f9fa', 
            borderRadius: '8px',
            border: '1px solid #dee2e6'
          }}>
            <Text fontSize="small" fontWeight="bold" marginBottom="10px">
              üêõ Panel de Debugging
            </Text>
            
            <View style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
              <Button
                onClick={() => setDebugMode(!debugMode)}
                variation={debugMode ? "primary" : "secondary"}
                size="small"
              >
                {debugMode ? "üêõ Modo DEBUG ON" : "üîÑ Modo Simple"}
              </Button>
              
              <Button
                onClick={testBackendRoute}
                variation="secondary"
                size="small"
                isDisabled={!sessionId}
              >
                üß™ Test Backend
              </Button>
            </View>
            
            <Text fontSize="small" color="gray">
              Session ID: {sessionId ? `${sessionId.substring(0, 8)}...` : 'N/A'}
            </Text>
            <Text fontSize="small" color="gray">
              Modo: {debugMode ? "Debug (an√°lisis detallado)" : "Simple (delays graduales)"}
            </Text>
          </View>

          {/* Mostrar estado de comparaci√≥n */}
          {comparing && (
            <Alert variation="info" hasIcon={true} marginBottom="15px">
              <View>
                <Text fontWeight="bold">Procesando verificaci√≥n...</Text>
                <Text>{progressMessage}</Text>
                {retryCount > 0 && (
                  <Text fontSize="small" color="gray">
                    Intento {retryCount + 1} de 3
                  </Text>
                )}
              </View>
            </Alert>
          )}
          
          <FaceLivenessDetector
            sessionId={sessionId}
            region="us-east-1"
            onAnalysisComplete={handleAnalysisComplete}
            onError={handleLivenessError}
            config={{
              faceDistanceThreshold: 0.3,
              faceDistanceThresholdMax: 0.8,
            }}
            displayText={{
              hintMoveFaceFrontOfCameraText: "Mueve tu cara frente a la c√°mara",
              hintTooManyFacesText: "Aseg√∫rate de que solo tu cara sea visible",
              hintFaceDetectedText: "Cara detectada correctamente",
              hintCanNotIdentifyText: "No se puede identificar tu cara",
              hintTooCloseText: "Al√©jate un poco de la c√°mara",
              hintTooFarText: "Ac√©rcate m√°s a la c√°mara"
            }}
          />
          
          <View marginTop="20px">
            <Button 
              onClick={retryLiveness}
              variation="secondary"
              size="large"
              width="100%"
              isDisabled={comparing}
            >
              {comparing ? 'Procesando...' : 'üîÑ Reiniciar verificaci√≥n'}
            </Button>
          </View>

          {/* Informaci√≥n de debugging */}
          <Alert variation="info" hasIcon={true} marginTop="15px">
            <View>
              <Text fontSize="small" fontWeight="bold" marginBottom="5px">
                üîç Informaci√≥n de debugging
              </Text>
              <Text fontSize="small" marginBottom="3px">
                ‚Ä¢ El modo DEBUG mostrar√° logs detallados en la consola
              </Text>
              <Text fontSize="small" marginBottom="3px">
                ‚Ä¢ Usa "Test Backend" para verificar la conectividad
              </Text>
              <Text fontSize="small" color="gray">
                ‚Ä¢ Revisa la consola del navegador (F12) para ver los logs detallados
              </Text>
            </View>
          </Alert>
        </View>
      ) : (
        <View className="error-container">
          <Text color="red" marginBottom="15px">
            Error al inicializar AWS Face Liveness
          </Text>
          <Button onClick={retryLiveness} variation="primary">
            üîÑ Reintentar
          </Button>
        </View>
      )}
    </Card>
  );
}

export default LivenessCheck;